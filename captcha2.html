<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>voice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #050505 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .captcha-container {
            background: #121212;
            border: 1px solid #222222;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
            text-align: center;
        }
        
        .header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #222222;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .step {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #333;
        }
        
        .step.completed {
            background: #00b894;
        }
        
        .step.active {
            background: #8a2be2;
        }
        
        h1 {
            color: #8a2be2;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .instructions {
            margin-bottom: 30px;
            line-height: 1.6;
            color: #a0a0a0;
        }
        
        .phrase-container {
            background: rgba(138, 43, 226, 0.1);
            border: 2px solid #8a2be2;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            text-align: center;
        }
        
        .phrase {
            font-size: 2.2rem;
            font-weight: bold;
            color: #8a2be2;
            margin: 15px 0;
            line-height: 1.3;
            text-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
            font-family: 'Georgia', serif;
            padding: 15px;
            border-radius: 10px;
            background: rgba(138, 43, 226, 0.05);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            min-width: 170px;
            justify-content: center;
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .record-btn {
            background: linear-gradient(135deg, #8a2be2, #5a189a);
            color: white;
        }
        
        .record-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(138, 43, 226, 0.5);
        }
        
        .record-btn.recording {
            background: linear-gradient(135deg, #e17055, #d63031);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(225, 112, 85, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(225, 112, 85, 0); }
            100% { box-shadow: 0 0 0 0 rgba(225, 112, 85, 0); }
        }
        
        .stop-btn {
            background: linear-gradient(135deg, #333, #222);
            color: white;
            border: 1px solid #444;
        }
        
        .recording-status {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #e17055, #d63031);
            border-radius: 12px;
            font-weight: 600;
            color: white;
            margin: 20px auto;
            max-width: 300px;
            justify-content: center;
        }
        
        .recording-status.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .pulse-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: dotPulse 1s infinite;
        }
        
        @keyframes dotPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
        }
        
        .result-container {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            display: none;
            animation: slideIn 0.5s ease;
        }
        
        .result-container.show {
            display: block;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .result-icon {
            font-size: 36px;
        }
        
        .result-text {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .success {
            color: #00b894;
        }
        
        .error {
            color: #fdcb6e;
        }
        
        .recognized-text {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.3rem;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-word;
            border: 2px solid #333;
        }
        
        .progress-container {
            margin: 25px 0;
        }
        
        .progress-bar {
            height: 12px;
            background: #333;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 1px solid #444;
        }
        
        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #e17055, #fdcb6e, #00b894);
            border-radius: 6px;
            transition: width 1s ease;
        }
        
        .progress-labels {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        
        .progress-label {
            font-size: 0.9rem;
            color: #a0a0a0;
        }
        
        .progress-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #8a2be2;
            font-family: monospace;
        }
        
        .auto-transition {
            margin: 30px 0;
            padding: 25px;
            background: rgba(0, 184, 148, 0.1);
            border-radius: 15px;
            border: 3px solid rgba(0, 184, 148, 0.3);
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .auto-transition.show {
            display: block;
        }
        
        .countdown {
            font-size: 3.5rem;
            font-weight: bold;
            color: #00b894;
            margin: 15px 0;
            font-family: monospace;
            text-shadow: 0 0 20px rgba(0, 184, 148, 0.5);
        }
        
        .transition-text {
            color: #a0a0a0;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .retry-btn {
            background: #333;
            color: #a0a0a0;
            border: 1px solid #444;
        }
        
        .retry-btn:hover {
            background: #444;
            color: #e0e0e0;
        }
        
        .browser-warning {
            color: #fdcb6e;
            background: rgba(253, 203, 110, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-size: 0.95rem;
            border: 2px solid rgba(253, 203, 110, 0.3);
            display: none;
            line-height: 1.5;
        }
        
        .browser-warning.show {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .phrase-hint {
            color: #fdcb6e;
            font-size: 0.9rem;
            margin-top: 10px;
            font-style: italic;
        }
        
        .success-animation {
            animation: successPulse 2s infinite;
        }
        
        @keyframes successPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .waiting-message {
            color: #8a2be2;
            margin: 20px 0;
            font-size: 1.1rem;
            padding: 15px;
            background: rgba(138, 43, 226, 0.1);
            border-radius: 10px;
            border: 2px solid rgba(138, 43, 226, 0.3);
        }
        
        .target-range {
            background: rgba(0, 184, 148, 0.1);
            border: 2px solid rgba(0, 184, 148, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        
        .target-title {
            color: #00b894;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .target-description {
            color: #a0a0a0;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .target-zone {
            display: inline-block;
            padding: 5px 15px;
            background: linear-gradient(135deg, #00b894, #8a2be2);
            color: white;
            border-radius: 20px;
            font-weight: bold;
            margin: 5px;
            font-size: 1.1rem;
        }
        
        .high-accuracy {
            color: #00cec9;
        }
        
        .high-accuracy-animation {
            animation: highAccuracyPulse 2s infinite;
        }
        
        @keyframes highAccuracyPulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 20px rgba(0, 206, 201, 0.3);
            }
            50% { 
                transform: scale(1.03); 
                box-shadow: 0 0 30px rgba(0, 206, 201, 0.5);
            }
        }
    </style>
</head>
<body>
    <div class="captcha-container">
        <div class="header">
            <div class="step-indicator">
                <div class="step completed">1</div>
                <div class="step active">2</div>
                <div class="step">3</div>
            </div>
            <h1>–¢–ï–ü–ï–†–¨ –ß–ï</h1>
            <div class="instructions">
                –ê –¢–ï–ü–ï–†–¨ –ü–†–û–¶–ï–ù–¢ –°–†–ï–ó–ê–ù –ù–ê–•–£–ô –° 65 –î–û 92.
            </div>
        </div>
        
        <div class="target-range">
            <div class="target-title">–ù–£ –î–ê–í–ê–ô –ß–ò–¢–ê–ô –°–¢–†–û–ß–ö–£ –õ–Æ–ë–ò–ú–û–ì–û –ò–°–ü–û–õ–ù–ò–¢–ï–õ–Ø.</div>
            <div class="target-description">
                –ù–£–ñ–ù–û –ù–ê–ë–†–ê–¢–¨ –ê –Ø –£–ñ–ï –ü–ò–°–ê–õ –°–ö–û–õ–¨–ö–û 
                <span class="target-zone"> –ù–û –¢–´ –ù–ï –ó–ê–ë–´–í–ê–ô –ú–ò–ù–ò–ú–£–ú 92%</span> 
                <br>
                <small>–†–ï–ö–õ–ê–ú–£ –¢–ê–ö –ò –ù–ï –ó–ê–ö–£–ü–ò–õ–ò –ñ–î–ê–õ –ì–û–î.</small>
            </div>
        </div>
        
        <div class="phrase-container">
            <div class="phrase" id="phrase">–¢–æ —á—Ç–æ —è –ª–∏–∑–∞–ª —Ç–µ–±–µ –∑–∞–±—É–¥—å —è –±—ã–ª –ø–æ–¥ –∫–æ–¥–µ–∏–Ω–æ–º</div>
            <div class="phrase-hint">–ê –ò –ï–©–ï –°–¢–û–ò–¢ –ü–õ–ê–ì–ò–ù –ö–û–¢–û–†–´–ô –í–°–ï –ü–û–ü–´–¢–ö–ò –ú–ù–ï –°–ö–ò–î–´–í–ê–ï–¢.</div>
            <div class="phrase-hint">–¢–ï–ü–ï–¨ –ú–£–¢ –î–°–ê –ù–ï –ü–û–ú–û–ñ–ï–¢, –û–ë–ù–Ø–õ.</div>
        </div>
        
        <div class="waiting-message" id="waitingMessage">
            ‚è≥ –ñ–ú–ê–ô –ù–ê–ß–ê–¢–¨"
        </div>
        
        <div class="browser-warning" id="browserWarning">
            ‚ö†Ô∏è –î–ª—è —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º –±—Ä–∞—É–∑–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ (Chrome, Edge).
            –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø.
        </div>
        
        <div class="controls">
            <button class="control-btn record-btn" id="startBtn">
                <span>üé§</span> –ù–ê–ß–ê–¢–¨
            </button>
            <button class="control-btn stop-btn" id="stopBtn" disabled>
                <span>‚èπÔ∏è</span> –û–°–¢–ê–ù–û–í–ò–¢–¨
            </button>
        </div>
        
        <div class="recording-status" id="recordingStatus">
            <div class="pulse-dot"></div>
            –ê –ó–ê–ü–ò–°–¨ –¢–û –ò–î–ï–¢.
        </div>
        
        <div class="result-container" id="resultContainer">
            <div class="result-header">
                <div class="result-icon" id="resultIcon">üéØ</div>
                <div class="result-text" id="resultText">–ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–ê</div>
            </div>
            
            <div class="recognized-text" id="recognizedText">
                –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-labels">
                    <div class="progress-label">–¢–û–ß–ù–û–°–¢–¨ –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–Ø</div>
                    <div class="progress-value" id="confidenceValue">0%</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn retry-btn" onclick="retryRecording()">
                    <span>üîÑ</span> –ü–û–ü–†–û–ë–û–í–ê–¢–¨ –ï–©–ï –†–ê–ó
                </button>
            </div>
        </div>
        
        <div class="auto-transition" id="autoTransition">
            <div class="countdown" id="countdown">3</div>
            <div class="transition-text">
                ‚úÖ –£–°–ü–ï–®–ù–û–ï –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –ê–•–ê–•–•–ê–ê<br>
                –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ —á–µ—Ä–µ–∑ <span id="secondsLeft">3</span> —Å–µ–∫—É–Ω–¥—ã
            </div>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const CONFIG = {
            targetPhrase: '–¢–æ —á—Ç–æ —è –ª–∏–∑–∞–ª —Ç–µ–±–µ –∑–∞–±—É–¥—å —è –±—ã–ª –ø–æ–¥ –∫–æ–¥–µ–∏–Ω–æ–º',
            successThreshold: 92,     // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ –¥–ª—è —É—Å–ø–µ—Ö–∞
            highAccuracyThreshold: 95, // –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å
            transitionTime: 3,
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
            recognitionConfig: {
                lang: 'ru-RU',
                continuous: true,
                interimResults: true,
                maxAlternatives: 5,
                audioConstraints: {
                    sampleRate: 48000,
                    echoCancellation: true,
                    noiseSuppression: true
                }
            }
        };
        
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isRecording = false;
        let transitionTimer = null;
        let countdownValue = CONFIG.transitionTime;
        let sessionId = Date.now();
        let currentScore = 0;
        
        // ========== DOM –≠–õ–ï–ú–ï–ù–¢–´ ==========
        const elements = {
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            recordingStatus: document.getElementById('recordingStatus'),
            resultContainer: document.getElementById('resultContainer'),
            recognizedText: document.getElementById('recognizedText'),
            resultIcon: document.getElementById('resultIcon'),
            resultText: document.getElementById('resultText'),
            progressFill: document.getElementById('progressFill'),
            confidenceValue: document.getElementById('confidenceValue'),
            autoTransition: document.getElementById('autoTransition'),
            countdown: document.getElementById('countdown'),
            secondsLeft: document.getElementById('secondsLeft'),
            browserWarning: document.getElementById('browserWarning'),
            phrase: document.getElementById('phrase'),
            waitingMessage: document.getElementById('waitingMessage')
        };
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function init() {
            console.log(`[VoiceCaptcha ${sessionId}] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø–æ—Ä–æ–≥–æ–º 92%...`);
            
            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
            localStorage.removeItem('captcha2Success');
            localStorage.removeItem('captcha2Phrase');
            localStorage.removeItem('captcha2Score');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –±—Ä–∞—É–∑–µ—Ä–∞
            const isSupported = checkBrowserSupport();
            
            if (isSupported) {
                initRecognition();
                elements.waitingMessage.style.display = 'block';
            }
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            elements.startBtn.addEventListener('click', startRecording);
            elements.stopBtn.addEventListener('click', stopRecording);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è —Ñ—Ä–∞–∑—ã
            animatePhrase();
            
            console.log(`[VoiceCaptcha ${sessionId}] –ü–æ—Ä–æ–≥ 92% –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω`);
        }
        
        // ========== –ü–†–û–í–ï–†–ö–ê –ü–û–î–î–ï–†–ñ–ö–ò –ë–†–ê–£–ó–ï–†–ê ==========
        function checkBrowserSupport() {
            if (!SpeechRecognition) {
                elements.browserWarning.classList.add('show');
                elements.startBtn.disabled = true;
                elements.startBtn.innerHTML = '<span>üö´</span> –ù–ï –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–¢–°–Ø';
                console.warn(`[VoiceCaptcha ${sessionId}] –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç SpeechRecognition API`);
                return false;
            }
            
            console.log(`[VoiceCaptcha ${sessionId}] –ë—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç SpeechRecognition API`);
            return true;
        }
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–Ø ==========
        function initRecognition() {
            try {
                recognition = new SpeechRecognition();
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
                recognition.lang = CONFIG.recognitionConfig.lang;
                recognition.continuous = CONFIG.recognitionConfig.continuous;
                recognition.interimResults = CONFIG.recognitionConfig.interimResults;
                recognition.maxAlternatives = CONFIG.recognitionConfig.maxAlternatives;
                
                console.log(`[VoiceCaptcha ${sessionId}] –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –ø–æ—Ä–æ–≥–∞ 92%`);
                
                recognition.onstart = function() {
                    isRecording = true;
                    elements.recordingStatus.classList.add('active');
                    elements.startBtn.disabled = true;
                    elements.startBtn.classList.add('recording');
                    elements.stopBtn.disabled = false;
                    elements.waitingMessage.style.display = 'none';
                    console.log(`[VoiceCaptcha ${sessionId}] –ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞`);
                };
                
                recognition.onresult = function(event) {
                    const result = event.results[0];
                    
                    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                    let bestScore = 0;
                    let bestTranscript = '';
                    
                    for (let i = 0; i < result.length; i++) {
                        const alternative = result[i];
                        const transcript = alternative.transcript.toLowerCase().trim();
                        const confidence = alternative.confidence;
                        
                        const analysis = analyzeSimilarity(transcript, CONFIG.targetPhrase);
                        const confidencePercent = Math.round(confidence * 100);
                        const similarityPercent = Math.round(analysis.similarity * 100);
                        
                        // –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
                        const score = Math.round(
                            (confidencePercent * 0.4) + 
                            (similarityPercent * 0.6)
                        );
                        
                        if (score > bestScore) {
                            bestScore = score;
                            bestTranscript = transcript;
                        }
                    }
                    
                    console.log(`[VoiceCaptcha ${sessionId}] –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: "${bestTranscript}" (–æ—Ü–µ–Ω–∫–∞: ${bestScore}%)`);
                    
                    processResult(bestTranscript, bestScore);
                };
                
                recognition.onerror = function(event) {
                    console.error(`[VoiceCaptcha ${sessionId}] –û—à–∏–±–∫–∞: ${event.error}`);
                    
                    let errorMessage = '–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è';
                    switch (event.error) {
                        case 'no-speech':
                            errorMessage = '–†–µ—á—å –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å –≥—Ä–æ–º—á–µ.';
                            break;
                        case 'audio-capture':
                            errorMessage = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.';
                            break;
                        case 'not-allowed':
                            errorMessage = '–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                            break;
                        default:
                            errorMessage = `–û—à–∏–±–∫–∞: ${event.error}`;
                    }
                    
                    showError(errorMessage);
                    stopRecording();
                };
                
                recognition.onend = function() {
                    console.log(`[VoiceCaptcha ${sessionId}] –ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞`);
                    stopRecording();
                };
                
            } catch (error) {
                console.error(`[VoiceCaptcha ${sessionId}] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:`, error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏');
            }
        }
        
        // ========== –ê–ù–ê–õ–ò–ó –°–•–û–î–°–¢–í–ê ==========
        function analyzeSimilarity(recognized, target) {
            const normalizeText = (text) => {
                return text.toLowerCase()
                    .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '')
                    .replace(/\s{2,}/g, ' ')
                    .trim();
            };
            
            const recognizedNormalized = normalizeText(recognized);
            const targetNormalized = normalizeText(target);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
            if (recognizedNormalized === targetNormalized) {
                return { similarity: 1.0, matchedWords: targetNormalized.split(' ').length };
            }
            
            const recognizedWords = recognizedNormalized.split(/\s+/);
            const targetWords = targetNormalized.split(/\s+/);
            
            let totalScore = 0;
            let matchedWords = 0;
            
            // –ê–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ–≤–∞
            targetWords.forEach((targetWord, targetIndex) => {
                let bestScore = 0;
                
                recognizedWords.forEach((recognizedWord, recIndex) => {
                    let score = 0;
                    
                    // –ü–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å–ª–æ–≤–∞
                    if (recognizedWord === targetWord) {
                        score = 1.0;
                    }
                    // –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                    else if (recognizedWord.includes(targetWord) || targetWord.includes(recognizedWord)) {
                        const minLen = Math.min(recognizedWord.length, targetWord.length);
                        const maxLen = Math.max(recognizedWord.length, targetWord.length);
                        score = 0.9 * (minLen / maxLen);
                    }
                    // –ü–æ—Ö–æ–∂–∏–µ —Å–ª–æ–≤–∞ (–ø–µ—Ä–≤—ã–µ 3 –±—É–∫–≤—ã)
                    else if (recognizedWord.slice(0, 3) === targetWord.slice(0, 3)) {
                        score = 0.7;
                    }
                    // –ü–æ—Ö–æ–∂–∏–µ —Å–ª–æ–≤–∞ (–ø–µ—Ä–≤—ã–µ 2 –±—É–∫–≤—ã)
                    else if (recognizedWord.slice(0, 2) === targetWord.slice(0, 2)) {
                        score = 0.5;
                    }
                    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ
                    else if (recognizedWord[0] === targetWord[0]) {
                        score = 0.3;
                    }
                    
                    // –ë–æ–Ω—É—Å –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
                    if (score > 0 && targetIndex === recIndex) {
                        score = Math.min(1.0, score + 0.2);
                    }
                    
                    if (score > bestScore) {
                        bestScore = score;
                    }
                });
                
                totalScore += bestScore;
                
                if (bestScore >= 0.7) {
                    matchedWords++;
                }
            });
            
            // –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞
            const baseSimilarity = totalScore / targetWords.length;
            const wordMatchRatio = matchedWords / targetWords.length;
            
            const finalSimilarity = (baseSimilarity * 0.7) + (wordMatchRatio * 0.3);
            
            return {
                similarity: Math.min(1.0, finalSimilarity),
                matchedWords: matchedWords,
                totalWords: targetWords.length
            };
        }
        
        // ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        
        function startRecording() {
            if (!recognition || isRecording) return;
            
            console.log(`[VoiceCaptcha ${sessionId}] –ó–∞–ø—É—Å–∫ –∑–∞–ø–∏—Å–∏ –¥–ª—è –ø–æ—Ä–æ–≥–∞ 92%...`);
            resetResults();
            
            try {
                recognition.start();
            } catch (error) {
                console.error(`[VoiceCaptcha ${sessionId}] –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:`, error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø–∏—Å—å. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            }
        }
        
        function stopRecording() {
            if (recognition && isRecording) {
                try {
                    recognition.stop();
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
                }
            }
            
            isRecording = false;
            elements.recordingStatus.classList.remove('active');
            elements.startBtn.disabled = false;
            elements.startBtn.classList.remove('recording');
            elements.stopBtn.disabled = true;
        }
        
        function processResult(transcript, score) {
            currentScore = score;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            elements.resultContainer.classList.add('show');
            elements.recognizedText.textContent = `"${transcript}"`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            elements.progressFill.style.width = score + '%';
            elements.confidenceValue.textContent = score + '%';
            
            console.log(`[VoiceCaptcha ${sessionId}] –ê–Ω–∞–ª–∏–∑:
                –û—Ü–µ–Ω–∫–∞: ${score}%
                –ü–æ—Ä–æ–≥ —É—Å–ø–µ—Ö–∞: ${CONFIG.successThreshold}%
                –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å: ${CONFIG.highAccuracyThreshold}%`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if (score >= CONFIG.successThreshold) {
                handleSuccess(transcript, score);
            } else {
                handleFailure(transcript, score);
            }
        }
        
        function handleSuccess(transcript, score) {
            console.log(`[VoiceCaptcha ${sessionId}] –£–°–ü–ï–•! –û—Ü–µ–Ω–∫–∞: ${score}%`);
            
            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞
            if (score >= CONFIG.highAccuracyThreshold) {
                elements.resultIcon.textContent = 'üéØ';
                elements.resultIcon.style.color = '#00cec9';
                elements.resultText.textContent = `–í–´–°–û–ö–ê–Ø –¢–û–ß–ù–û–°–¢–¨ (${score}%)`;
                elements.resultText.className = 'result-text high-accuracy';
                elements.resultContainer.classList.add('high-accuracy-animation');
            } else {
                elements.resultIcon.textContent = '‚úÖ';
                elements.resultIcon.style.color = '#00b894';
                elements.resultText.textContent = `–£–°–ü–ï–®–ù–û (${score}%)`;
                elements.resultText.className = 'result-text success';
                elements.resultContainer.classList.add('success-animation');
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É—Å–ø–µ—Ö
            sessionStorage.setItem('captcha2Success', 'true');
            sessionStorage.setItem('captcha2Phrase', transcript);
            sessionStorage.setItem('captcha2Score', score);
            sessionStorage.setItem('captcha2Session', sessionId);
            
            // –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç
            startCountdown();
        }
        
        function handleFailure(transcript, score) {
            console.log(`[VoiceCaptcha ${sessionId}] –ù–ï–£–î–ê–ß–ê –û—Ü–µ–Ω–∫–∞: ${score}%`);
            
            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ—É–¥–∞—á–∏
            elements.resultIcon.textContent = '‚ùå';
            elements.resultIcon.style.color = '#fdcb6e';
            elements.resultText.textContent = `–ù–£–ñ–ù–û –õ–£–ß–®–ï (${score}%)`;
            elements.resultText.className = 'result-text error';
            elements.resultContainer.classList.remove('success-animation', 'high-accuracy-animation');
            
            // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è
            const needed = CONFIG.successThreshold - score;
            elements.recognizedText.innerHTML = `
                "${transcript}"<br>
                <small style="color: #fdcb6e;">
                    –ì–û–í–û–†–ò –©–ê  ${needed}% –ê –ù–ê–î–û ${CONFIG.successThreshold}%<br>
                    –ê–•–ê–•–ê–•
                </small>
            `;
        }
        
        function startCountdown() {
            countdownValue = CONFIG.transitionTime;
            elements.autoTransition.classList.add('show');
            elements.countdown.textContent = countdownValue;
            elements.secondsLeft.textContent = countdownValue;
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
            elements.startBtn.disabled = true;
            elements.stopBtn.disabled = true;
            
            console.log(`[VoiceCaptcha ${sessionId}] –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç: ${countdownValue} —Å–µ–∫—É–Ω–¥`);
            
            transitionTimer = setInterval(() => {
                countdownValue--;
                elements.countdown.textContent = countdownValue;
                elements.secondsLeft.textContent = countdownValue;
                
                if (countdownValue <= 0) {
                    clearInterval(transitionTimer);
                    completeTransition();
                }
            }, 1000);
        }
        
        function completeTransition() {
            console.log(`[VoiceCaptcha ${sessionId}] –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –∫–∞–ø—á—É...`);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            localStorage.setItem('captcha2Passed', 'true');
            localStorage.setItem('captcha2Score', currentScore);
            localStorage.setItem('captcha2Timestamp', new Date().toISOString());
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            elements.autoTransition.innerHTML = `
                <div class="countdown" style="color: #00b894;">‚úÖ</div>
                <div class="transition-text">
                    <strong style="color: #00b894; font-size: 1.2rem;">–£–°–ü–ï–®–ù–û–ï –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï ${currentScore}%!</strong><br>
                    –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É...
                </div>
            `;
            
            // –ü–µ—Ä–µ—Ö–æ–¥ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            setTimeout(() => {
                window.location.href = 'captcha3.html';
            }, 1000);
        }
        
        function resetResults() {
            elements.resultContainer.classList.remove('show');
            elements.autoTransition.classList.remove('show');
            elements.progressFill.style.width = '0%';
            elements.confidenceValue.textContent = '0%';
            elements.resultContainer.classList.remove('success-animation', 'high-accuracy-animation');
            elements.waitingMessage.style.display = 'none';
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –±–ª–æ–∫ –∞–≤—Ç–æ-–ø–µ—Ä–µ—Ö–æ–¥–∞
            elements.autoTransition.innerHTML = `
                <div class="countdown" id="countdown">3</div>
                <div class="transition-text">
                    ‚úÖ –£–°–ü–ï–®–ù–û–ï –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï<br>
                    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ —á–µ—Ä–µ–∑ <span id="secondsLeft">3</span> —Å–µ–∫—É–Ω–¥—ã
                </div>
            `;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã
            elements.countdown = document.getElementById('countdown');
            elements.secondsLeft = document.getElementById('secondsLeft');
            
            if (transitionTimer) {
                clearInterval(transitionTimer);
                transitionTimer = null;
            }
            
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
            elements.startBtn.disabled = false;
            currentScore = 0;
        }
        
        function showError(message) {
            elements.resultContainer.classList.add('show');
            elements.resultIcon.textContent = '‚ö†Ô∏è';
            elements.resultIcon.style.color = '#fdcb6e';
            elements.resultText.textContent = message;
            elements.resultText.className = 'result-text error';
            elements.recognizedText.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            elements.progressFill.style.width = '0%';
            elements.confidenceValue.textContent = '0%';
        }
        
        function retryRecording() {
            console.log(`[VoiceCaptcha ${sessionId}] –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞`);
            resetResults();
        }
        
        
        
        // ========== –ó–ê–ü–£–°–ö ==========
        document.addEventListener('DOMContentLoaded', init);
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        window.retryRecording = retryRecording;
    </script>
</body>
</html>